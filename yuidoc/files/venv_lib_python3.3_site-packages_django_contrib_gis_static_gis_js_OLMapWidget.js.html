<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>venv/lib/python3.3/site-packages/django/contrib/gis/static/gis/js/OLMapWidget.js - The Blintus Status API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="The Blintus Status API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/HomeController.html">HomeController</a></li>
            
                <li><a href="../classes/HomeView.html">HomeView</a></li>
            
                <li><a href="../classes/Store.html">Store</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: venv/lib/python3.3/site-packages/django/contrib/gis/static/gis/js/OLMapWidget.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function() {
/**
 * Transforms an array of features to a single feature with the merged
 * geometry of geom_type
 */
OpenLayers.Util.properFeatures = function(features, geom_type) {
    if (features.constructor == Array) {
        var geoms = [];
        for (var i=0; i&lt;features.length; i++) {
            geoms.push(features[i].geometry);
        }
        var geom = new geom_type(geoms);
        features = new OpenLayers.Feature.Vector(geom);
    }
    return features;
}

/**
 * @requires OpenLayers/Format/WKT.js
 */

/**
 * Class: OpenLayers.Format.DjangoWKT
 * Class for reading Well-Known Text, with workarounds to successfully parse
 * geometries and collections as returned by django.contrib.gis.geos.
 *
 * Inherits from:
 *  - &lt;OpenLayers.Format.WKT&gt;
 */

OpenLayers.Format.DjangoWKT = OpenLayers.Class(OpenLayers.Format.WKT, {
    initialize: function(options) {
        OpenLayers.Format.WKT.prototype.initialize.apply(this, [options]);
        this.regExes.justComma = /\s*,\s*/;
    },

    parse: {
        &#x27;point&#x27;: function(str) {
            var coords = OpenLayers.String.trim(str).split(this.regExes.spaces);
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Point(coords[0], coords[1])
            );
        },

        &#x27;multipoint&#x27;: function(str) {
            var point;
            var points = OpenLayers.String.trim(str).split(this.regExes.justComma);
            var components = [];
            for(var i=0, len=points.length; i&lt;len; ++i) {
                point = points[i].replace(this.regExes.trimParens, &#x27;$1&#x27;);
                components.push(this.parse.point.apply(this, [point]).geometry);
            }
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.MultiPoint(components)
            );
        },

        &#x27;linestring&#x27;: function(str) {
            var points = OpenLayers.String.trim(str).split(&#x27;,&#x27;);
            var components = [];
            for(var i=0, len=points.length; i&lt;len; ++i) {
                components.push(this.parse.point.apply(this, [points[i]]).geometry);
            }
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.LineString(components)
            );
        },

        &#x27;multilinestring&#x27;: function(str) {
            var line;
            var lines = OpenLayers.String.trim(str).split(this.regExes.parenComma);
            var components = [];
            for(var i=0, len=lines.length; i&lt;len; ++i) {
                line = lines[i].replace(this.regExes.trimParens, &#x27;$1&#x27;);
                components.push(this.parse.linestring.apply(this, [line]).geometry);
            }
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.MultiLineString(components)
            );
        },

        &#x27;polygon&#x27;: function(str) {
            var ring, linestring, linearring;
            var rings = OpenLayers.String.trim(str).split(this.regExes.parenComma);
            var components = [];
            for(var i=0, len=rings.length; i&lt;len; ++i) {
                ring = rings[i].replace(this.regExes.trimParens, &#x27;$1&#x27;);
                linestring = this.parse.linestring.apply(this, [ring]).geometry;
                linearring = new OpenLayers.Geometry.LinearRing(linestring.components);
                components.push(linearring);
            }
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Polygon(components)
            );
        },

        &#x27;multipolygon&#x27;: function(str) {
            var polygon;
            var polygons = OpenLayers.String.trim(str).split(this.regExes.doubleParenComma);
            var components = [];
            for(var i=0, len=polygons.length; i&lt;len; ++i) {
                polygon = polygons[i].replace(this.regExes.trimParens, &#x27;$1&#x27;);
                components.push(this.parse.polygon.apply(this, [polygon]).geometry);
            }
            return new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.MultiPolygon(components)
            );
        },

        &#x27;geometrycollection&#x27;: function(str) {
            // separate components of the collection with |
            str = str.replace(/,\s*([A-Za-z])/g, &#x27;|$1&#x27;);
            var wktArray = OpenLayers.String.trim(str).split(&#x27;|&#x27;);
            var components = [];
            for(var i=0, len=wktArray.length; i&lt;len; ++i) {
                components.push(OpenLayers.Format.WKT.prototype.read.apply(this,[wktArray[i]]));
            }
            return components;
        }
    },

    extractGeometry: function(geometry) {
        var type = geometry.CLASS_NAME.split(&#x27;.&#x27;)[2].toLowerCase();
        if (!this.extract[type]) {
            return null;
        }
        if (this.internalProjection &amp;&amp; this.externalProjection) {
            geometry = geometry.clone();
            geometry.transform(this.internalProjection, this.externalProjection);
        }
        var wktType = type == &#x27;collection&#x27; ? &#x27;GEOMETRYCOLLECTION&#x27; : type.toUpperCase();
        var data = wktType + &#x27;(&#x27; + this.extract[type].apply(this, [geometry]) + &#x27;)&#x27;;
        return data;
    },

    /**
     * Patched write: successfully writes WKT for geometries and
     * geometrycollections.
     */
    write: function(features) {
        var collection, geometry, type, data, isCollection;
        isCollection = features.geometry.CLASS_NAME == &quot;OpenLayers.Geometry.Collection&quot;;
        var pieces = [];
        if (isCollection) {
            collection = features.geometry.components;
            pieces.push(&#x27;GEOMETRYCOLLECTION(&#x27;);
            for (var i=0, len=collection.length; i&lt;len; ++i) {
                if (i&gt;0) {
                    pieces.push(&#x27;,&#x27;);
                }
                pieces.push(this.extractGeometry(collection[i]));
            }
            pieces.push(&#x27;)&#x27;);
        } else {
            pieces.push(this.extractGeometry(features.geometry));
        }
        return pieces.join(&#x27;&#x27;);
    },

    CLASS_NAME: &quot;OpenLayers.Format.DjangoWKT&quot;
});

function MapWidget(options) {
    this.map = null;
    this.controls = null;
    this.panel = null;
    this.layers = {};
    this.wkt_f = new OpenLayers.Format.DjangoWKT();

    // Mapping from OGRGeomType name to OpenLayers.Geometry name
    if (options[&#x27;geom_name&#x27;] == &#x27;Unknown&#x27;) options[&#x27;geom_type&#x27;] = OpenLayers.Geometry;
    else if (options[&#x27;geom_name&#x27;] == &#x27;GeometryCollection&#x27;) options[&#x27;geom_type&#x27;] = OpenLayers.Geometry.Collection;
    else options[&#x27;geom_type&#x27;] = eval(&#x27;OpenLayers.Geometry.&#x27; + options[&#x27;geom_name&#x27;]);

    // Default options
    this.options = {
        color: &#x27;ee9900&#x27;,
        default_lat: 0,
        default_lon: 0,
        default_zoom: 4,
        is_collection: new options[&#x27;geom_type&#x27;]() instanceof OpenLayers.Geometry.Collection,
        layerswitcher: false,
        map_options: {},
        map_srid: 4326,
        modifiable: true,
        mouse_position: false,
        opacity: 0.4,
        point_zoom: 12,
        scale_text: false,
        scrollable: true
    };

    // Altering using user-provided options
    for (var property in options) {
        if (options.hasOwnProperty(property)) {
            this.options[property] = options[property];
        }
    }

    this.map = this.create_map();

    var defaults_style = {
        &#x27;fillColor&#x27;: &#x27;#&#x27; + this.options.color,
        &#x27;fillOpacity&#x27;: this.options.opacity,
        &#x27;strokeColor&#x27;: &#x27;#&#x27; + this.options.color
    };
    if (this.options.geom_name == &#x27;LineString&#x27;) {
        defaults_style[&#x27;strokeWidth&#x27;] = 3;
    }
    var styleMap = new OpenLayers.StyleMap({&#x27;default&#x27;: OpenLayers.Util.applyDefaults(defaults_style, OpenLayers.Feature.Vector.style[&#x27;default&#x27;])});
    this.layers.vector = new OpenLayers.Layer.Vector(&quot; &quot; + this.options.name, {styleMap: styleMap});
    this.map.addLayer(this.layers.vector);
    var wkt = document.getElementById(this.options.id).value;
    if (wkt) {
        var feat = OpenLayers.Util.properFeatures(this.read_wkt(wkt), this.options.geom_type);
        this.write_wkt(feat);
        if (this.options.is_collection) {
            for (var i=0; i&lt;this.num_geom; i++) {
                this.layers.vector.addFeatures([new OpenLayers.Feature.Vector(feat.geometry.components[i].clone())]);
            }
        } else {
            this.layers.vector.addFeatures([feat]);
        }
        this.map.zoomToExtent(feat.geometry.getBounds());
        if (this.options.geom_name == &#x27;Point&#x27;) {
            this.map.zoomTo(this.options.point_zoom);
        }
    } else {
        this.map.setCenter(this.defaultCenter(), this.options.default_zoom);
    }
    this.layers.vector.events.on({&#x27;featuremodified&#x27;: this.modify_wkt, scope: this});
    this.layers.vector.events.on({&#x27;featureadded&#x27;: this.add_wkt, scope: this});

    this.getControls(this.layers.vector);
    this.panel.addControls(this.controls);
    this.map.addControl(this.panel);
    this.addSelectControl();

    if (this.options.mouse_position) {
        this.map.addControl(new OpenLayers.Control.MousePosition());
    }
    if (this.options.scale_text) {
        this.map.addControl(new OpenLayers.Control.Scale());
    }
    if (this.options.layerswitcher) {
        this.map.addControl(new OpenLayers.Control.LayerSwitcher());
    }
    if (!this.options.scrollable) {
        this.map.getControlsByClass(&#x27;OpenLayers.Control.Navigation&#x27;)[0].disableZoomWheel();
    }
    if (wkt) {
        if (this.options.modifiable) {
            this.enableEditing();
        }
    } else {
        this.enableDrawing();
    }
}

MapWidget.prototype.create_map = function() {
    var map = new OpenLayers.Map(this.options.map_id, this.options.map_options);
    if (this.options.base_layer) this.layers.base = this.options.base_layer;
    else this.layers.base = new OpenLayers.Layer.WMS(&#x27;OpenLayers WMS&#x27;, &#x27;http://vmap0.tiles.osgeo.org/wms/vmap0&#x27;, {layers: &#x27;basic&#x27;});
    map.addLayer(this.layers.base);
    return map
};

MapWidget.prototype.get_ewkt = function(feat) {
    return &quot;SRID=&quot; + this.options.map_srid + &quot;;&quot; + this.wkt_f.write(feat);
};

MapWidget.prototype.read_wkt = function(wkt) {
    var prefix = &#x27;SRID=&#x27; + this.options.map_srid + &#x27;;&#x27;
    if (wkt.indexOf(prefix) === 0) {
        wkt = wkt.slice(prefix.length);
    }
    return this.wkt_f.read(wkt);
};

MapWidget.prototype.write_wkt = function(feat) {
    feat = OpenLayers.Util.properFeatures(feat, this.options.geom_type);
    if (this.options.is_collection) {
        this.num_geom = feat.geometry.components.length;
    } else {
        this.num_geom = 1;
    }
    document.getElementById(this.options.id).value = this.get_ewkt(feat);
};

MapWidget.prototype.add_wkt = function(event) {
    if (this.options.is_collection) {
        var feat = new OpenLayers.Feature.Vector(new this.options.geom_type());
        for (var i=0; i&lt;this.layers.vector.features.length; i++) {
            feat.geometry.addComponents([this.layers.vector.features[i].geometry]);
        }
        this.write_wkt(feat);
    } else {
        if (this.layers.vector.features.length &gt; 1) {
            old_feats = [this.layers.vector.features[0]];
            this.layers.vector.removeFeatures(old_feats);
            this.layers.vector.destroyFeatures(old_feats);
        }
        this.write_wkt(event.feature);
    }
};

MapWidget.prototype.modify_wkt = function(event) {
    if (this.options.is_collection) {
        if (this.options.geom_name == &#x27;MultiPoint&#x27;) {
            this.add_wkt(event);
            return;
        } else {
            var feat = new OpenLayers.Feature.Vector(new this.options.geom_type());
            for (var i=0; i&lt;this.num_geom; i++) {
                feat.geometry.addComponents([this.layers.vector.features[i].geometry]);
            }
            this.write_wkt(feat);
        }
    } else {
        this.write_wkt(event.feature);
    }
};

MapWidget.prototype.deleteFeatures = function() {
    this.layers.vector.removeFeatures(this.layers.vector.features);
    this.layers.vector.destroyFeatures();
};

MapWidget.prototype.clearFeatures = function() {
    this.deleteFeatures();
    document.getElementById(this.options.id).value = &#x27;&#x27;;
    this.map.setCenter(this.defaultCenter(), this.options.default_zoom);
};

MapWidget.prototype.defaultCenter = function() {
    var center = new OpenLayers.LonLat(this.options.default_lon, this.options.default_lat);
    if (this.options.map_srid) {
        return center.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;), this.map.getProjectionObject());
    }
    return center;
};

MapWidget.prototype.addSelectControl = function() {
    var select = new OpenLayers.Control.SelectFeature(this.layers.vector, {&#x27;toggle&#x27;: true, &#x27;clickout&#x27;: true});
    this.map.addControl(select);
    select.activate();
};

MapWidget.prototype.enableDrawing = function () {
    this.map.getControlsByClass(&#x27;OpenLayers.Control.DrawFeature&#x27;)[0].activate();
};

MapWidget.prototype.enableEditing = function () {
    this.map.getControlsByClass(&#x27;OpenLayers.Control.ModifyFeature&#x27;)[0].activate();
};

MapWidget.prototype.getControls = function(layer) {
    this.panel = new OpenLayers.Control.Panel({&#x27;displayClass&#x27;: &#x27;olControlEditingToolbar&#x27;});
    this.controls = [new OpenLayers.Control.Navigation()];
    if (!this.options.modifiable &amp;&amp; layer.features.length)
        return;
    if (this.options.geom_name.indexOf(&#x27;LineString&#x27;) &gt;= 0 || this.options.geom_name == &#x27;GeometryCollection&#x27; || this.options.geom_name == &#x27;Unknown&#x27;) {
        this.controls.push(new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Path, {&#x27;displayClass&#x27;: &#x27;olControlDrawFeaturePath&#x27;}));
    }
    if (this.options.geom_name.indexOf(&#x27;Polygon&#x27;) &gt;= 0 || this.options.geom_name == &#x27;GeometryCollection&#x27; || this.options.geom_name == &#x27;Unknown&#x27;) {
        this.controls.push(new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Polygon, {&#x27;displayClass&#x27;: &#x27;olControlDrawFeaturePolygon&#x27;}));
    }
    if (this.options.geom_name.indexOf(&#x27;Point&#x27;) &gt;= 0 || this.options.geom_name == &#x27;GeometryCollection&#x27; || this.options.geom_name == &#x27;Unknown&#x27;) {
        this.controls.push(new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Point, {&#x27;displayClass&#x27;: &#x27;olControlDrawFeaturePoint&#x27;}));
    }
    if (this.options.modifiable) {
        this.controls.push(new OpenLayers.Control.ModifyFeature(layer, {&#x27;displayClass&#x27;: &#x27;olControlModifyFeature&#x27;}));
    }
};
window.MapWidget = MapWidget;
})();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
